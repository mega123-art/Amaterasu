<?xml version="1.0" encoding="UTF-8"?>
<svg width="1400" height="520" viewBox="0 0 1400 520" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <linearGradient id="grad1" x1="0" x2="1">
      <stop offset="0" stop-color="#2b6cb0" stop-opacity="0.95"/>
      <stop offset="1" stop-color="#3182ce" stop-opacity="0.95"/>
    </linearGradient>
    <linearGradient id="grad2" x1="0" x2="1">
      <stop offset="0" stop-color="#4c51bf" stop-opacity="0.95"/>
      <stop offset="1" stop-color="#6b46c1" stop-opacity="0.95"/>
    </linearGradient>
    <style type="text/css"><![CDATA[
      .title { font: 700 20px/1.1 'Inter', Arial, sans-serif; fill:#0b2545; }
      .step-label { font: 600 13px/1 'Inter', Arial, sans-serif; fill:#ffffff; }
      .step-sub { font: 400 11px/1 'Inter', Arial, sans-serif; fill:#e6eef8; }
      .box { rx:12; ry:12; }
      .arrow { stroke: #6B7280; stroke-width: 2.6; fill: none; marker-end: url(#arrowhead); }
      .note { font: 400 12px/1 'Inter', Arial, sans-serif; fill:#0b2545; }
    ]]></style>

    <marker id="arrowhead" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="8" markerHeight="8" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#6B7280"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="100%" height="100%" fill="#ffffff"/>

  <!-- Title -->
  <text x="40" y="36" class="title">BFT-PoLoc — High-level Workflow</text>
  <text x="40" y="58" class="note">Paper-level Proof-of-Location using PoIG, robust filtering, trigonometric R*, and on-chain staking/voting.</text>

  <!-- Step 1: Claim Submission -->
  <g transform="translate(40,100)">
    <rect class="box" width="190" height="80" fill="url(#grad1)" stroke="#1e40af" stroke-width="1.2"/>
    <text x="18" y="36" class="step-label">Claim Submission</text>
    <text x="18" y="56" class="step-sub">Waldo submits claimed coordinates & stake</text>
  </g>

  <!-- Arrow 1 -->
  <path class="arrow" d="M 230 140 L 320 140" />

  <!-- Step 2: Challenger Selection -->
  <g transform="translate(340,100)">
    <rect class="box" width="210" height="80" fill="#111827" opacity="0.9" stroke="#0f172a" stroke-width="1.2"/>
    <text x="18" y="36" class="step-label">Challenger Selection</text>
    <text x="18" y="56" class="step-sub">Coordinator picks challengers within X km</text>
  </g>

  <!-- Arrow 2 -->
  <path class="arrow" d="M 560 140 L 650 140" />

  <!-- Step 3: RTT Measurement -->
  <g transform="translate(670,64)">
    <rect class="box" width="220" height="56" fill="url(#grad2)" stroke="#553c9a" stroke-width="1.0"/>
    <text x="16" y="36" class="step-label">RTT Measurement</text>
  </g>
  <g transform="translate(670,130)">
    <rect class="box" width="220" height="50" fill="#2b6cb0" stroke="#1e3a8a" stroke-width="0.8"/>
    <text x="16" y="156-100" class="step-sub" style="fill:#e6eef8">Challengers probe Waldo & trusted anchors (20 UDP pings)</text>
    <text x="16" y="168" class="step-sub">Min(RTT) used to reduce congestion noise</text>
  </g>

  <!-- Arrow 3 -->
  <path class="arrow" d="M 890 140 L 980 140" />

  <!-- Step 4: Robust Filtering -->
  <g transform="translate(1000,64)">
    <rect class="box" width="225" height="56" fill="#111827" opacity="0.95" stroke="#0f172a" stroke-width="1.0"/>
    <text x="16" y="36" class="step-label">Robust Filtering</text>
    <text x="16" y="56" class="step-sub">Filter by distance/delay ratio, MAD/IQR</text>
  </g>

  <!-- Arrow 4 -->
  <path class="arrow" d="M 1110 120 L 1110 200" />

  <!-- Step 5: Monotone Mapping -->
  <g transform="translate(860,220)">
    <rect class="box" width="260" height="88" fill="url(#grad1)" stroke="#1e40af" stroke-width="1.2"/>
    <text x="18" y="256-30" class="step-label">Monotone Delay→Distance Mapping</text>
    <text x="18" y="276-30" class="step-sub">Per-challenger upper-envelope mapping (Section 5)</text>
  </g>

  <!-- Arrow 5 -->
  <path class="arrow" d="M 1120 266 L 1240 266" />

  <!-- Step 6: R* Calculation (Equation 6) -->
  <g transform="translate(1260,220)">
    <rect class="box" width="260" height="88" fill="#4c51bf" stroke="#3b82f6" stroke-width="1.2"/>
    <text x="18" y="256-10" class="step-label">Trigonometric R* Calculation</text>
    <text x="18" y="276-10" class="step-sub">Use Equation (6): <tspan font-style="italic">R<sub>i</sub</tspan> ≤ sqrt(ĥd<sub>i</sub>² − d̃<sub>i</sub>² sin²α) − d̃<sub>i</sub> cos α</text>
  </g>

  <!-- Arrow 6 -->
  <path class="arrow" d="M 1420 266 L 1500 266" />

  <!-- Step 7: Matrix Completion -->
  <g transform="translate(40,340)">
    <rect class="box" width="290" height="88" fill="#2b6cb0" stroke="#1e3a8a" stroke-width="1.2"/>
    <text x="18" y="368" class="step-label">Matrix Completion (Optional)</text>
    <text x="18" y="392" class="step-sub">Recover missing RTTs, detect corrupted columns (M = L + C)</text>
  </g>

  <!-- Arrow 7 -->
  <path class="arrow" d="M 330 384 L 440 384" />

  <!-- Step 8: On-chain Consensus -->
  <g transform="translate(460,340)">
    <rect class="box" width="340" height="88" fill="#111827" opacity="0.95" stroke="#0f172a" stroke-width="1.2"/>
    <text x="20" y="376" class="step-label">Blockchain Consensus (Solana + Anchor)</text>
    <text x="20" y="396" class="step-sub">Stake, submit signed measurements, finalize & store R*</text>
  </g>

  <!-- Arrow 8 -->
  <path class="arrow" d="M 800 384 L 940 384" />

  <!-- Step 9: Rewards / Slashing -->
  <g transform="translate(960,340)">
    <rect class="box" width="280" height="88" fill="#4c51bf" stroke="#3b82f6" stroke-width="1.2"/>
    <text x="18" y="368" class="step-label">Rewards & Slashing</text>
    <text x="18" y="392" class="step-sub">Automatic per-challenge payouts or slashes for bad actors</text>
  </g>

  <!-- Footer note -->
  <text x="40" y="490" class="note">Diagram: High-level workflow of BFT-PoLoc. Key math: Monotone mapping (Sec.5), Equation (6) trig bound for R*, matrix completion M = L + C.</text>
</svg>
